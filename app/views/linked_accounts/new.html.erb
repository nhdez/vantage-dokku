<% content_for :title, "Link New Account" %>

<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1 text-gray-800">
            <i class="fas fa-plus me-2 text-primary"></i>
            Link New Account
          </h1>
          <p class="text-muted mb-0">Connect an external service to access repositories and enhance your workflow</p>
        </div>
        <div>
          <%= link_to linked_accounts_path, class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-2"></i>Back to Linked Accounts
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-link me-2"></i>Account Information
          </h6>
        </div>
        <div class="card-body">
          <%= form_with model: @linked_account, local: true, class: "needs-validation", novalidate: true do |form| %>
            <% if @linked_account.errors.any? %>
              <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Please fix the following errors:</h6>
                <ul class="mb-0">
                  <% @linked_account.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <!-- Provider Selection -->
            <div class="mb-4">
              <%= form.label :provider, class: "form-label fw-bold" %>
              <%= form.select :provider, 
                  options_for_select(@available_providers.map { |p| [p.capitalize, p] }, @linked_account.provider),
                  { prompt: "Select a provider..." },
                  { class: "form-select", required: true, onchange: "updateProviderInfo()" } %>
              <div class="form-text">Choose the external service you want to connect</div>
            </div>

            <!-- Provider-specific Information -->
            <div id="provider-info" class="mb-4" style="display: none;">
              <!-- GitHub Instructions -->
              <div id="github-info" class="provider-instructions" style="display: none;">
                <div class="alert alert-info">
                  <h6><i class="fab fa-github me-2"></i>GitHub Personal Access Token Required</h6>
                  <p class="mb-3">To link your GitHub account, you need to create a Personal Access Token (PAT) with the appropriate permissions.</p>
                  
                  <h6>Steps to create a GitHub Personal Access Token:</h6>
                  <ol>
                    <li>Go to <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">GitHub Settings → Developer settings → Personal access tokens</a></li>
                    <li>Click "Generate new token" → "Generate new token (classic)"</li>
                    <li>Give your token a descriptive name (e.g., "Vantage Dokku Integration")</li>
                    <li>Select the following scopes:
                      <ul class="mt-2">
                        <li><code>repo</code> - Full control of private repositories</li>
                        <li><code>read:user</code> - Read user profile data</li>
                        <li><code>user:email</code> - Access user email addresses</li>
                        <li><code>read:org</code> - Read organization membership (optional)</li>
                      </ul>
                    </li>
                    <li>Click "Generate token"</li>
                    <li>Copy the token immediately (you won't be able to see it again)</li>
                    <li>Paste it in the "Access Token" field below</li>
                  </ol>
                  
                  <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Keep your token secure and never share it. We encrypt and store it safely.
                  </div>
                </div>
              </div>
            </div>

            <!-- Access Token -->
            <div class="mb-4">
              <%= form.label :access_token, class: "form-label fw-bold" %>
              <%= form.text_area :access_token, 
                  class: "form-control", 
                  required: true,
                  rows: 3,
                  placeholder: "Paste your access token here...",
                  style: "font-family: monospace;" %>
              <div class="form-text">
                Your access token will be encrypted and stored securely. We'll never share it with anyone.
              </div>
            </div>

            <!-- Optional Fields -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <%= form.label :account_username, "Username (Optional)", class: "form-label" %>
                <%= form.text_field :account_username, 
                    class: "form-control",
                    placeholder: "e.g. your-username" %>
                <div class="form-text">We'll try to auto-detect this from your token</div>
              </div>
              <div class="col-md-6 mb-3">
                <%= form.label :account_email, "Email (Optional)", class: "form-label" %>
                <%= form.email_field :account_email, 
                    class: "form-control",
                    placeholder: "e.g. user@example.com" %>
                <div class="form-text">We'll try to auto-detect this from your token</div>
              </div>
            </div>

            <!-- Active Toggle -->
            <div class="mb-4">
              <div class="form-check">
                <%= form.check_box :active, class: "form-check-input", checked: true %>
                <%= form.label :active, "Active", class: "form-check-label" %>
              </div>
              <div class="form-text">Inactive accounts won't be used for API calls</div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <%= link_to linked_accounts_path, class: "btn btn-outline-secondary me-md-2" do %>
                <i class="fas fa-times me-2"></i>Cancel
              <% end %>
              <%= form.submit "Link Account", class: "btn btn-primary" do %>
                <i class="fas fa-link me-2"></i>Link Account
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function updateProviderInfo() {
  const providerSelect = document.getElementById('linked_account_provider');
  const providerInfo = document.getElementById('provider-info');
  const allInstructions = document.querySelectorAll('.provider-instructions');
  
  // Hide all instructions first
  allInstructions.forEach(instruction => {
    instruction.style.display = 'none';
  });
  
  if (providerSelect.value) {
    providerInfo.style.display = 'block';
    
    // Show specific provider instructions
    const selectedInstruction = document.getElementById(providerSelect.value + '-info');
    if (selectedInstruction) {
      selectedInstruction.style.display = 'block';
    }
  } else {
    providerInfo.style.display = 'none';
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateProviderInfo();
});
</script>

<style>
.text-gray-800 {
  color: #5a5c69 !important;
}
.card {
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}
</style>
