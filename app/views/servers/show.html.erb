<% content_for :title, @server.name %>

<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1 text-gray-800">
            <i class="fas fa-server me-2 text-primary"></i>
            <%= @server.name %>
          </h1>
          <p class="text-muted mb-0">Server details and management</p>
        </div>
        <div>
          <%= link_to edit_server_path(@server), class: "btn btn-primary me-2" do %>
            <i class="fas fa-edit me-2"></i>Edit Server
          <% end %>
          <%= link_to servers_path, class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-2"></i>Back to Servers
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Server Information -->
    <div class="col-md-8">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-info-circle me-2"></i>Server Information
          </h6>
        </div>
        <div class="card-body">
          <!-- Server Status Alert -->
          <% if @server_status %>
            <div class="alert alert-<%= @server_status[:online] ? 'success' : 'warning' %> mb-3">
              <i class="fas fa-<%= @server_status[:online] ? 'check-circle' : 'exclamation-triangle' %> me-2"></i>
              <strong>Server Status:</strong> <%= @server_status[:message] %>
              <small class="d-block mt-1">Last checked: <%= time_ago_in_words(@server_status[:last_checked]) %> ago</small>
            </div>
          <% end %>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">Server Name</h6>
              <p class="h5 mb-0"><%= @server.name %></p>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">Service Provider</h6>
              <p class="h5 mb-0">
                <% if @server.service_provider.present? %>
                  <span class="badge bg-success fs-6"><%= @server.service_provider %></span>
                <% else %>
                  <span class="text-muted">Not specified</span>
                <% end %>
              </p>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">IP Address</h6>
              <p class="h5 mb-0">
                <code class="text-info fs-6"><%= @server.ip %></code>
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">Internal IP</h6>
              <p class="h5 mb-0">
                <% if @server.internal_ip.present? %>
                  <code class="text-secondary fs-6"><%= @server.internal_ip %></code>
                <% else %>
                  <span class="text-muted">Not configured</span>
                <% end %>
              </p>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">SSH Username</h6>
              <p class="h5 mb-0">
                <span class="badge bg-secondary fs-6"><%= @server.username %></span>
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">SSH Port</h6>
              <p class="h5 mb-0">
                <span class="badge bg-info fs-6"><%= @server.port %></span>
              </p>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">Added</h6>
              <p class="mb-0">
                <%= @server.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                <small class="text-muted d-block"><%= time_ago_in_words(@server.created_at) %> ago</small>
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <h6 class="text-muted">Last Updated</h6>
              <p class="mb-0">
                <%= @server.updated_at.strftime("%B %d, %Y at %I:%M %p") %>
                <small class="text-muted d-block"><%= time_ago_in_words(@server.updated_at) %> ago</small>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Connection Details -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-plug me-2"></i>Connection Details
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-12">
              <h6 class="text-muted">SSH Connection Command</h6>
              <div class="bg-dark text-white p-3 rounded">
                <code class="text-white">
                  ssh <%= @server.username %>@<%= @server.ip %><%= " -p #{@server.port}" if @server.port != 22 %>
                </code>
                <button class="btn btn-sm btn-outline-light ms-2" onclick="copyToClipboard(this)" data-text="ssh <%= @server.username %>@<%= @server.ip %><%= " -p #{@server.port}" if @server.port != 22 %>">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-12">
              <h6 class="text-muted">Authentication Methods</h6>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-2">
                    <% if ENV['DOKKU_SSH_KEY_PATH'].present? %>
                      <div class="alert alert-success py-2">
                        <i class="fas fa-key me-2"></i>
                        <strong>SSH Key:</strong> <%= ENV['DOKKU_SSH_KEY_PATH'] %>
                      </div>
                    <% else %>
                      <div class="alert alert-warning py-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>SSH Key:</strong> Not configured
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="col-md-6">
                  <div>
                    <% if @server.has_password_auth? %>
                      <div class="alert alert-success py-2">
                        <i class="fas fa-lock me-2"></i>
                        <strong>Password:</strong> Configured (encrypted)
                      </div>
                    <% else %>
                      <div class="alert alert-secondary py-2">
                        <i class="fas fa-times me-2"></i>
                        <strong>Password:</strong> Not configured
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>

              <% if @server.has_key_auth? || @server.has_password_auth? %>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Connection will try SSH key first, then fallback to password.
                </small>
              <% else %>
                <div class="alert alert-danger py-2">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Warning:</strong> No authentication method configured!
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Deployments on this Server -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-rocket me-2"></i>Applications & Deployments
          </h6>
        </div>
        <div class="card-body">
          <% if @deployments.any? %>
            <div class="row">
              <% @deployments.each do |deployment| %>
                <div class="col-md-6 mb-3">
                  <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                      <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                          <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            <%= link_to deployment_path(deployment), class: "text-decoration-none" do %>
                              <%= deployment.name %>
                            <% end %>
                          </div>
                          <div class="h5 mb-1 font-weight-bold text-gray-800">
                            <span class="badge bg-info fs-6"><%= deployment.dokku_app_name %></span>
                          </div>
                          
                          <!-- Health Status -->
                          <% if deployment.application_healths.any? %>
                            <% latest_health = deployment.application_healths.recent.first %>
                            <div class="mb-2">
                              <span class="badge bg-<%= latest_health.status == 'healthy' ? 'success' : 'danger' %> me-2">
                                <i class="fas fa-<%= latest_health.status == 'healthy' ? 'check' : 'times' %> me-1"></i>
                                <%= latest_health.status.humanize %>
                              </span>
                              <small class="text-muted">
                                Last checked <%= time_ago_in_words(latest_health.checked_at) %> ago
                              </small>
                            </div>
                            
                            <!-- Health Status Grid (last 10 checks) -->
                            <div class="health-status-grid mb-2">
                              <% deployment.application_healths.recent.limit(10).each do |health_check| %>
                                <div class="health-dot bg-<%= health_check.status == 'healthy' ? 'success' : 'danger' %>" 
                                     title="<%= health_check.checked_at.strftime('%b %d, %H:%M') %> - <%= health_check.status.humanize %>"></div>
                              <% end %>
                            </div>
                          <% else %>
                            <div class="mb-2">
                              <span class="badge bg-secondary">
                                <i class="fas fa-question me-1"></i>
                                No health data
                              </span>
                            </div>
                          <% end %>
                          
                          <!-- Domains -->
                          <% if deployment.domains.any? %>
                            <div class="mb-2">
                              <h6 class="text-muted mb-1" style="font-size: 0.75rem;">Domains:</h6>
                              <% deployment.domains.limit(2).each do |domain| %>
                                <span class="badge bg-secondary me-1" style="font-size: 0.7rem;" 
                                      title="<%= domain.name %> - SSL status will be checked in background">
                                  <i class="fas fa-globe me-1"></i>
                                  <%= domain.name %>
                                </span>
                              <% end %>
                              <% if deployment.domains.count > 2 %>
                                <span class="text-muted" style="font-size: 0.7rem;">+<%= deployment.domains.count - 2 %> more</span>
                              <% end %>
                            </div>
                          <% end %>
                          
                          <div class="text-muted" style="font-size: 0.75rem;">
                            Created <%= time_ago_in_words(deployment.created_at) %> ago
                          </div>
                        </div>
                        <div class="col-auto">
                          <i class="fas fa-rocket fa-2x text-gray-300"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
            
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-info py-2">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong><%= @deployments.count %></strong> deployment<%= 's' unless @deployments.count == 1 %> 
                  running on this server. Click on any deployment name to view details.
                </div>
              </div>
            </div>
          <% else %>
            <div class="text-center text-muted py-4">
              <i class="fas fa-rocket fa-3x mb-3"></i>
              <h5>No Deployments</h5>
              <p>This server doesn't have any applications deployed yet.</p>
              <%= link_to new_deployment_path, class: "btn btn-primary" do %>
                <i class="fas fa-plus me-2"></i>Create First Deployment
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-md-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-cogs me-2"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button id="test-connection-btn" class="btn btn-outline-success" onclick="testConnection('<%= test_connection_server_path(@server) %>')">
              <i class="fas fa-plug me-2"></i>Test Connection
            </button>
            <button id="update-server-btn" class="btn btn-outline-primary" onclick="updateServer('<%= update_server_server_path(@server) %>')">
              <i class="fas fa-sync-alt me-2"></i>Update Server
            </button>
            <button id="restart-server-btn" class="btn btn-outline-primary" onclick="restartServer('<%= restart_server_server_path(@server) %>')">
              <i class="fas fa-power-off me-2"></i>Restart Server
            </button>
            <% unless @server.dokku_installed? %>
              <button id="install-dokku-btn" class="btn btn-outline-primary" onclick="installDokku('<%= install_dokku_server_path(@server) %>')">
                <i class="fas fa-download me-2"></i>Install Dokku
              </button>
            <% end %>
            <%= link_to logs_server_path(@server), class: "btn btn-outline-primary" do %>
              <i class="fas fa-file-alt me-2"></i>View Logs
            <% end %>
            <%= link_to edit_server_path(@server), class: "btn btn-outline-primary" do %>
              <i class="fas fa-edit me-2"></i>Edit Configuration
            <% end %>
            <%= link_to server_path(@server), method: :delete, 
                class: "btn btn-outline-danger",
                data: { 
                  confirm: "Are you sure you want to delete '#{@server.name}'? This action cannot be undone.",
                  turbo_method: :delete
                } do %>
              <i class="fas fa-trash me-2"></i>Delete Server
            <% end %>
          </div>
        </div>
      </div>

      <!-- Server Information -->
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-server me-2"></i>System Information
          </h6>
        </div>
        <div class="card-body" id="server-info-section">
          <% if @server.os_version.present? %>
            <div class="row mb-3">
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">Operating System</h6>
                <p class="mb-0"><%= @server.os_version %></p>
              </div>
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">CPU</h6>
                <p class="mb-0">
                  <% if @server.cpu_model.present? %>
                    <%= @server.cpu_model %>
                    <% if @server.cpu_cores.present? %>
                      <br><small class="text-muted"><%= @server.cpu_cores %> cores</small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">Unknown</span>
                  <% end %>
                </p>
              </div>
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">Memory</h6>
                <p class="mb-0"><%= @server.formatted_ram %></p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">Disk Space</h6>
                <p class="mb-0"><%= @server.formatted_disk %></p>
              </div>
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">Dokku Version</h6>
                <p class="mb-0">
                  <% if @server.dokku_installed? %>
                    <span class="badge bg-success fs-6"><%= @server.formatted_dokku_version %></span>
                  <% else %>
                    <span class="text-muted">Not detected</span>
                  <% end %>
                </p>
              </div>
              <div class="col-sm-4">
                <h6 class="text-muted mb-1">Last Connected</h6>
                <p class="mb-0"><%= @server.last_connected_ago %></p>
              </div>
            </div>
          <% else %>
            <div class="text-center text-muted py-3">
              <i class="fas fa-info-circle fa-2x mb-3"></i>
              <p>System information will be available after testing the connection.</p>
              <p class="small">Click "Test Connection" to gather server details.</p>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Connection Status -->
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-wifi me-2"></i>Connection Status
          </h6>
        </div>
        <div class="card-body" id="connection-status-section">
          <div class="text-center mb-3">
            <span class="badge <%= @server.connection_status_badge_class %> fs-6 px-3 py-2">
              <i class="<%= @server.connection_status_icon %> me-2"></i><%= @server.connection_status.titleize %>
            </span>
          </div>
          
          <div class="row text-center">
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Last Test</h6>
              <% if @server.last_connected_at.present? %>
                <p class="mb-0">
                  <%= @server.last_connected_at.strftime("%B %d, %Y") %>
                  <br><small class="text-muted"><%= @server.last_connected_at.strftime("%I:%M %p") %></small>
                </p>
              <% else %>
                <p class="text-muted mb-0">Never tested</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-1">Result</h6>
              <% case @server.connection_status %>
              <% when 'connected' %>
                <p class="text-success mb-0">
                  <i class="fas fa-check-circle me-1"></i>
                  Connection successful
                  <br><small class="text-muted">Server is reachable</small>
                </p>
              <% when 'failed' %>
                <p class="text-danger mb-0">
                  <i class="fas fa-times-circle me-1"></i>
                  Connection failed
                  <br><small class="text-muted">Check credentials or network</small>
                </p>
              <% else %>
                <p class="text-warning mb-0">
                  <i class="fas fa-question-circle me-1"></i>
                  Status unknown
                  <br><small class="text-muted">Test connection to verify</small>
                </p>
              <% end %>
            </div>
          </div>
          
          <% if @server.connection_status == 'connected' && @server.last_connected_at.present? %>
            <div class="alert alert-success mt-3 py-2">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Last successful connection:</strong> <%= @server.last_connected_ago %>
              <br><small>Server information was gathered and is up to date.</small>
            </div>
          <% elsif @server.connection_status == 'failed' %>
            <div class="alert alert-warning mt-3 py-2">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Connection issues detected.</strong> Try testing the connection again or check your SSH credentials.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyToClipboard(button) {
  const text = button.getAttribute('data-text');
  navigator.clipboard.writeText(text).then(function() {
    const icon = button.querySelector('i');
    icon.className = 'fas fa-check';
    setTimeout(() => {
      icon.className = 'fas fa-copy';
    }, 2000);
  });
}

let testConnectionChannel = null;

function testConnection(url) {
  const btn = document.getElementById('test-connection-btn');
  const originalText = btn.innerHTML;
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing Connection...';
  
  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('info', data.message, 'Connection Test');
      
      // Subscribe to ActionCable channel for real-time updates
      subscribeToTestConnection(data.server_uuid, btn, originalText);
    } else {
      // Reset button on immediate failure
      btn.disabled = false;
      btn.innerHTML = originalText;
      showToast('error', data.message, 'Connection Failed');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = originalText;
    showToast('error', 'An unexpected error occurred while testing the connection.', 'Connection Error');
  });
}

function subscribeToTestConnection(serverUuid, btn, originalText) {
  // Disconnect any existing channel
  if (testConnectionChannel) {
    testConnectionChannel.unsubscribe();
  }
  
  // Subscribe to the test connection channel
  testConnectionChannel = window.actionCableConsumer.subscriptions.create(
    { 
      channel: "TestConnectionChannel",
      server_uuid: serverUuid
    },
    {
      received: function(data) {
        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
          showToast('success', data.message, 'Connection Successful');
          
          // Update connection status section
          updateConnectionStatus(data.connection_status);
          
          // Update server information section with new data
          if (data.server_data) {
            updateServerInformation(data.server_data);
          }
        } else {
          showToast('error', data.message, 'Connection Failed');
          updateConnectionStatus(data.connection_status);
        }
        
        // Unsubscribe after receiving the result
        this.unsubscribe();
        testConnectionChannel = null;
      }
    }
  );
}

function updateConnectionStatus(status) {
  const statusSection = document.getElementById('connection-status-section');
  let badgeClass, icon, statusText;
  
  switch(status) {
    case 'connected':
      badgeClass = 'bg-success';
      icon = 'fas fa-check-circle';
      statusText = 'Connected';
      break;
    case 'failed':
      badgeClass = 'bg-danger';
      icon = 'fas fa-times-circle';
      statusText = 'Failed';
      break;
    default:
      badgeClass = 'bg-warning text-dark';
      icon = 'fas fa-question-circle';
      statusText = 'Unknown';
  }
  
  // Update the status badge
  const badge = statusSection.querySelector('.badge');
  if (badge) {
    badge.className = `badge ${badgeClass} fs-6 px-3 py-2`;
    badge.innerHTML = `<i class="${icon} me-2"></i>${statusText}`;
  }
}

function updateServerInformation(serverData) {
  const serverInfoSection = document.getElementById('server-info-section');
  
  // Create the updated system information HTML
  const systemInfoHtml = `
    <div class="row mb-3">
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">Operating System</h6>
        <p class="mb-0">${serverData.os_version || 'Unknown'}</p>
      </div>
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">CPU</h6>
        <p class="mb-0">
          ${serverData.cpu_model || '<span class="text-muted">Unknown</span>'}
          ${serverData.cpu_cores ? `<br><small class="text-muted">${serverData.cpu_cores} cores</small>` : ''}
        </p>
      </div>
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">Memory</h6>
        <p class="mb-0">${serverData.ram_total || 'Unknown'}</p>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">Disk Space</h6>
        <p class="mb-0">${serverData.disk_total || 'Unknown'}</p>
      </div>
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">Dokku Version</h6>
        <p class="mb-0">
          ${serverData.dokku_installed ? 
            `<span class="badge bg-success fs-6">${serverData.dokku_version}</span>` : 
            '<span class="text-muted">Not detected</span>'
          }
        </p>
      </div>
      <div class="col-sm-4">
        <h6 class="text-muted mb-1">Last Connected</h6>
        <p class="mb-0">${serverData.last_connected_ago || 'Never'}</p>
      </div>
    </div>
  `;
  
  // Update the server info section
  serverInfoSection.innerHTML = systemInfoHtml;
  
  // Add a subtle animation to indicate the update
  serverInfoSection.style.opacity = '0.5';
  setTimeout(() => {
    serverInfoSection.style.opacity = '1';
    serverInfoSection.style.transition = 'opacity 0.3s ease';
  }, 100);
}

function updateDokkuStatus(serverData) {
  // Find the Dokku version element in the server info section
  const serverInfoSection = document.getElementById('server-info-section');
  const dokkuVersionElement = serverInfoSection.querySelector('.col-sm-4:nth-child(2) p');
  
  if (dokkuVersionElement && serverData.dokku_installed) {
    dokkuVersionElement.innerHTML = `<span class="badge bg-success fs-6">${serverData.dokku_version}</span>`;
    
    // Add a subtle animation to indicate the update
    dokkuVersionElement.style.opacity = '0.5';
    setTimeout(() => {
      dokkuVersionElement.style.opacity = '1';
      dokkuVersionElement.style.transition = 'opacity 0.3s ease';
    }, 100);
  }
}

function showToast(type, message, title) {
  // This function integrates with the app's existing toast system
  // Create a toast element and show it
  const toastHtml = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <strong>${title}:</strong> ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-mdb-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  const toastContainer = document.querySelector('.toast-container') || document.body;
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = toastContainer.lastElementChild;
  const toast = new mdb.Toast(toastElement);
  toast.show();
  
  // Remove toast element after it's hidden
  toastElement.addEventListener('hidden.mdb.toast', () => {
    toastElement.remove();
  });
}

function viewDashboard() {
  alert('Dokku dashboard integration will be implemented in the next phase.');
}

let updateServerChannel = null;

function updateServer(url) {
  const btn = document.getElementById('update-server-btn');
  const originalText = btn.innerHTML;
  
  // Confirm action
  if (!confirm('This will run "sudo apt update && sudo apt upgrade -y" on the server. This may take several minutes. Continue?')) {
    return;
  }
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating Server...';
  
  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('info', data.message, 'Server Update');
      
      // Subscribe to ActionCable channel for real-time updates
      subscribeToUpdateServer(data.server_uuid, btn, originalText);
    } else {
      // Reset button on immediate failure
      btn.disabled = false;
      btn.innerHTML = originalText;
      showToast('error', data.message, 'Update Failed');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = originalText;
    showToast('error', 'An unexpected error occurred while updating the server.', 'Update Error');
  });
}

function subscribeToUpdateServer(serverUuid, btn, originalText) {
  // Disconnect any existing channel
  if (updateServerChannel) {
    updateServerChannel.unsubscribe();
  }
  
  // Subscribe to the update server channel
  updateServerChannel = window.actionCableConsumer.subscriptions.create(
    { 
      channel: "UpdateServerChannel",
      server_uuid: serverUuid
    },
    {
      received: function(data) {
        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
          if (data.reboot_required) {
            showToast('warning', data.message, 'Update Complete - Reboot Required');
          } else {
            showToast('success', data.message, 'Update Successful');
          }
          
          // Show update output in a modal
          if (data.output) {
            showUpdateOutput(data.output);
          }
        } else {
          showToast('error', data.message, 'Update Failed');
          
          // Show error output if available
          if (data.output) {
            showUpdateOutput(data.output);
          }
        }
        
        // Unsubscribe after receiving the result
        this.unsubscribe();
        updateServerChannel = null;
      }
    }
  );
}

function showUpdateOutput(output) {
  // Create a modal to show the update output
  const modalHtml = `
    <div class="modal fade" id="updateOutputModal" tabindex="-1" aria-labelledby="updateOutputModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateOutputModalLabel">
              <i class="fas fa-terminal me-2"></i>Server Update Output
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-dark text-white p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.875rem;">${output}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('updateOutputModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Show modal
  const modal = new mdb.Modal(document.getElementById('updateOutputModal'));
  modal.show();
  
  // Clean up modal after it's hidden
  document.getElementById('updateOutputModal').addEventListener('hidden.mdb.modal', function() {
    this.remove();
  });
}

let installDokkuChannel = null;

function installDokku(url) {
  const btn = document.getElementById('install-dokku-btn');
  const originalText = btn.innerHTML;
  
  // Confirm action
  if (!confirm('This will install Dokku on the server and set up SSH keys. This process may take 5-10 minutes. Continue?')) {
    return;
  }
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Installing Dokku...';
  
  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('info', data.message, 'Dokku Installation');
      
      // Subscribe to ActionCable channel for real-time updates
      subscribeToInstallDokku(data.server_uuid, btn, originalText);
    } else {
      // Reset button on immediate failure
      btn.disabled = false;
      btn.innerHTML = originalText;
      showToast('error', data.message, 'Installation Failed');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = originalText;
    showToast('error', 'An unexpected error occurred during Dokku installation.', 'Installation Error');
  });
}

function subscribeToInstallDokku(serverUuid, btn, originalText) {
  // Disconnect any existing channel
  if (installDokkuChannel) {
    installDokkuChannel.unsubscribe();
  }
  
  // Subscribe to the install Dokku channel
  installDokkuChannel = window.actionCableConsumer.subscriptions.create(
    { 
      channel: "InstallDokkuChannel",
      server_uuid: serverUuid
    },
    {
      received: function(data) {
        if (data.success) {
          showToast('success', data.message, 'Dokku Installation');
          
          // Show installation output
          if (data.output) {
            showInstallationOutput(data.output);
          }
          
          // Update server information if Dokku version is available
          if (data.server_data) {
            updateDokkuStatus(data.server_data);
          }
          
          // Hide the Install Dokku button since it's now installed
          btn.style.display = 'none';
          
          // Show success message and option to reload
          setTimeout(() => {
            if (confirm('Dokku installation completed! Would you like to refresh the page to see the updated interface?')) {
              window.location.reload();
            }
          }, 2000);
        } else {
          showToast('error', data.message, 'Installation Failed');
          
          // Show error output if available
          if (data.output) {
            showInstallationOutput(data.output);
          }
          
          // Reset button on failure
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
        
        // Unsubscribe after receiving the result
        this.unsubscribe();
        installDokkuChannel = null;
      }
    }
  );
}

function showInstallationOutput(output) {
  // Create a modal to show the installation output
  const modalHtml = `
    <div class="modal fade" id="installationOutputModal" tabindex="-1" aria-labelledby="installationOutputModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="installationOutputModalLabel">
              <i class="fas fa-terminal me-2"></i>Dokku Installation Output
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-dark text-white p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.875rem;">${output}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('installationOutputModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Show modal
  const modal = new mdb.Modal(document.getElementById('installationOutputModal'));
  modal.show();
  
  // Clean up modal after it's hidden
  document.getElementById('installationOutputModal').addEventListener('hidden.mdb.modal', function() {
    this.remove();
  });
}

function restartServer(url) {
  const btn = document.getElementById('restart-server-btn');
  const originalText = btn.innerHTML;
  
  // Confirm action with strong warning
  if (!confirm('⚠️ WARNING: This will immediately restart the server using "sudo shutdown -r now".\n\nThe server will be unavailable for several minutes during the restart.\n\nAre you sure you want to proceed?')) {
    return;
  }
  
  // Show loading state
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restarting Server...';
  
  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    // Reset button
    btn.disabled = false;
    btn.innerHTML = originalText;
    
    if (data.success) {
      showToast('warning', data.message, 'Server Restart');
      
      // Show restart output
      if (data.output) {
        showRestartOutput(data.output);
      }
    } else {
      showToast('error', data.message, 'Restart Failed');
      
      // Show error output if available
      if (data.output) {
        showRestartOutput(data.output);
      }
    }
  })
  .catch(error => {
    console.error('Error:', error);
    btn.disabled = false;
    btn.innerHTML = originalText;
    showToast('error', 'An unexpected error occurred while restarting the server.', 'Restart Error');
  });
}

function showRestartOutput(output) {
  // Create a modal to show the restart output
  const modalHtml = `
    <div class="modal fade" id="restartOutputModal" tabindex="-1" aria-labelledby="restartOutputModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="restartOutputModalLabel">
              <i class="fas fa-power-off me-2"></i>Server Restart Output
            </h5>
            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-dark text-white p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.875rem;">${output}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.getElementById('restartOutputModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Show modal
  const modal = new mdb.Modal(document.getElementById('restartOutputModal'));
  modal.show();
  
  // Clean up modal after it's hidden
  document.getElementById('restartOutputModal').addEventListener('hidden.mdb.modal', function() {
    this.remove();
  });
}

function viewLogs() {
  alert('Log viewing will be implemented in the next phase.');
}
</script>

<style>
.text-gray-800 {
  color: #5a5c69 !important;
}
.card {
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

/* Health status grid styling */
.health-status-grid {
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
}

.health-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  cursor: help;
}

.border-left-primary {
  border-left: 0.25rem solid #4e73df !important;
}
</style>
